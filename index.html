/* ============================================================
   BATCH 1 ‚Äî CORE GAME STATE & DETERMINISTIC LOOP (FINAL)
   Product: Kanmathi Island
   Scope: Canonical state container + tick loop + invariants
============================================================ */

"use strict";

/* -------------------------------
   GLOBAL CONFIG (IMMUTABLE)
-------------------------------- */
const CONFIG = Object.freeze({
  GRID_SIZE: 4,
  MAX_HISTORY: 64,
  TICK_MS: 16,            // 60 FPS logical clock
  RNG_SEED: 1337,         // deterministic by default
});

/* -------------------------------
   DETERMINISTIC RNG (LCG)
-------------------------------- */
function createRNG(seed) {
  let s = seed >>> 0;
  return function rng() {
    // Numerical Recipes LCG
    s = (1664525 * s + 1013904223) >>> 0;
    return s / 0xffffffff;
  };
}

/* -------------------------------
   GAME STATE (SINGLE SOURCE)
-------------------------------- */
const GameState = {
  version: 1,
  startedAt: 0,
  tick: 0,

  rng: createRNG(CONFIG.RNG_SEED),

  grid: null,            // Int32Array backed
  score: 0,
  best: 0,

  history: [],           // bounded snapshots
  dirty: false,          // render invalidation flag
  running: false,
};

/* -------------------------------
   INVARIANT CHECKS
-------------------------------- */
function assert(condition, msg) {
  if (!condition) {
    throw new Error("[KANMATHI][ASSERT] " + msg);
  }
}

function validateGrid(grid) {
  assert(grid instanceof Int32Array, "Grid must be Int32Array");
  assert(
    grid.length === CONFIG.GRID_SIZE * CONFIG.GRID_SIZE,
    "Grid size mismatch"
  );
  for (let i = 0; i < grid.length; i++) {
    assert(Number.isInteger(grid[i]), "Grid contains non-integer");
    assert(grid[i] >= 0, "Grid contains negative value");
  }
}

/* -------------------------------
   GRID HELPERS
-------------------------------- */
function index(x, y) {
  return y * CONFIG.GRID_SIZE + x;
}

function cloneGrid(src) {
  const g = new Int32Array(src.length);
  g.set(src);
  return g;
}

/* -------------------------------
   STATE INITIALIZATION
-------------------------------- */
function initGame(seed = CONFIG.RNG_SEED) {
  GameState.rng = createRNG(seed);
  GameState.grid = new Int32Array(CONFIG.GRID_SIZE * CONFIG.GRID_SIZE);
  GameState.score = 0;
  GameState.tick = 0;
  GameState.history.length = 0;
  GameState.startedAt = performance.now();
  GameState.running = true;
  GameState.dirty = true;

  validateGrid(GameState.grid);
}

/* -------------------------------
   SNAPSHOT (FOR UNDO / REPLAY)
-------------------------------- */
function pushHistory() {
  if (GameState.history.length >= CONFIG.MAX_HISTORY) {
    GameState.history.shift();
  }
  GameState.history.push({
    grid: cloneGrid(GameState.grid),
    score: GameState.score,
    tick: GameState.tick,
  });
}

/* -------------------------------
   CORE TICK LOOP (NO RENDER)
-------------------------------- */
let _accumulator = 0;
let _lastTime = 0;

function step(now) {
  if (!GameState.running) return;

  if (!_lastTime) _lastTime = now;
  const delta = now - _lastTime;
  _lastTime = now;
  _accumulator += delta;

  while (_accumulator >= CONFIG.TICK_MS) {
    GameState.tick++;
    // Future: deterministic systems hook here
    _accumulator -= CONFIG.TICK_MS;
  }

  requestAnimationFrame(step);
}

/* -------------------------------
   PUBLIC API (LOCKED)
-------------------------------- */
const Core = Object.freeze({
  init: initGame,
  start() {
    assert(GameState.grid, "Game not initialized");
    if (!GameState.running) {
      GameState.running = true;
      _lastTime = 0;
      requestAnimationFrame(step);
    }
  },
  stop() {
    GameState.running = false;
  },
  snapshot: pushHistory,
  getState() {
    validateGrid(GameState.grid);
    return GameState;
  },
});

/* -------------------------------
   BOOTSTRAP (SAFE)
-------------------------------- */
(function bootstrap() {
  try {
    initGame();
    Core.start();
  } catch (e) {
    console.error("[KANMATHI][FATAL]", e);
    GameState.running = false;
  }
})();
/* ============================================================
   BATCH 2 ‚Äî CHILD-SAFE GAME LOGIC + SCORING RULES (FINAL)
   Product: Kanmathi Island
   Scope: Deterministic merge logic, non-punitive scoring,
          undo-safe, frustration-free mechanics
============================================================ */

"use strict";

/* -------------------------------
   CHILD-SAFE SCORING CONFIG
-------------------------------- */
const SCORE_RULES = Object.freeze({
  BASE_MERGE: 1,          // every merge is positive
  MAX_PER_MOVE: 50,      // hard cap to avoid pressure
  NO_FAIL_PENALTY: true, // never subtract score
});

/* -------------------------------
   GRID ITERATION HELPERS
-------------------------------- */
function forEachCell(fn) {
  const s = CONFIG.GRID_SIZE;
  for (let y = 0; y < s; y++) {
    for (let x = 0; x < s; x++) {
      fn(x, y, index(x, y));
    }
  }
}

function emptyCells() {
  const cells = [];
  forEachCell((x, y, i) => {
    if (GameState.grid[i] === 0) cells.push(i);
  });
  return cells;
}

/* -------------------------------
   SPAWN LOGIC (GENTLE)
-------------------------------- */
function spawnNumber() {
  const empties = emptyCells();
  if (!empties.length) return false;

  const idx = empties[Math.floor(GameState.rng() * empties.length)];
  // child-safe: always small numbers
  GameState.grid[idx] = GameState.rng() < 0.9 ? 1 : 2;
  GameState.dirty = true;
  return true;
}

/* -------------------------------
   LINE COMPRESSION (PURE)
-------------------------------- */
function compressLine(values) {
  const out = [];
  let gained = 0;

  for (let i = 0; i < values.length; i++) {
    if (values[i] === 0) continue;

    if (out.length && out[out.length - 1] === values[i]) {
      out[out.length - 1]++;
      gained += SCORE_RULES.BASE_MERGE;
    } else {
      out.push(values[i]);
    }
  }

  while (out.length < values.length) out.push(0);

  return { out, gained };
}

/* -------------------------------
   MOVE EXECUTION (DETERMINISTIC)
-------------------------------- */
function move(dir) {
  assert(["up","down","left","right"].includes(dir), "Invalid move");

  pushHistory();

  let moved = false;
  let totalGain = 0;
  const s = CONFIG.GRID_SIZE;

  function get(x, y) {
    return GameState.grid[index(x, y)];
  }
  function set(x, y, v) {
    GameState.grid[index(x, y)] = v;
  }

  for (let i = 0; i < s; i++) {
    let line = [];

    for (let j = 0; j < s; j++) {
      if (dir === "left")  line.push(get(j, i));
      if (dir === "right") line.push(get(s - 1 - j, i));
      if (dir === "up")    line.push(get(i, j));
      if (dir === "down")  line.push(get(i, s - 1 - j));
    }

    const { out, gained } = compressLine(line);
    totalGain += gained;

    for (let j = 0; j < s; j++) {
      let prev, next;
      if (dir === "left")  { prev = get(j, i); next = out[j]; set(j, i, next); }
      if (dir === "right") { prev = get(s - 1 - j, i); next = out[j]; set(s - 1 - j, i, next); }
      if (dir === "up")    { prev = get(i, j); next = out[j]; set(i, j, next); }
      if (dir === "down")  { prev = get(i, s - 1 - j); next = out[j]; set(i, s - 1 - j, next); }

      if (prev !== next) moved = true;
    }
  }

  if (!moved) {
    GameState.history.pop(); // undo snapshot
    return false;
  }

  // child-safe score clamp
  GameState.score += Math.min(totalGain, SCORE_RULES.MAX_PER_MOVE);
  GameState.best = Math.max(GameState.best, GameState.score);

  spawnNumber();
  GameState.dirty = true;
  return true;
}

/* -------------------------------
   INPUT HOOK (KEYBOARD)
-------------------------------- */
window.addEventListener("keydown", (e) => {
  if (!GameState.running) return;

  const map = {
    ArrowLeft: "left",
    ArrowRight: "right",
    ArrowUp: "up",
    ArrowDown: "down",
  };

  const dir = map[e.key];
  if (dir) {
    e.preventDefault();
    move(dir);
  }
});

/* -------------------------------
   INITIAL SPAWNS
-------------------------------- */
spawnNumber();
spawnNumber();
/* ============================================================
   BATCH 3 ‚Äî MASCOT INTELLIGENCE + ENCOURAGEMENT SYSTEM (FINAL)
   Product: Kanmathi Island (Children‚Äôs Edition)
   Scope: Deterministic mascot FSM, child-safe language,
          fatigue-free encouragement, zero pressure
============================================================ */

"use strict";

/* -------------------------------
   MASCOT ELEMENTS
-------------------------------- */
const MascotUI = (() => {
  const root = document.createElement("div");
  root.id = "mascot-layer";
  root.style.cssText = `
    text-align:center;
    margin:8px 0 12px;
    user-select:none;
    pointer-events:none;
  `;

  const icon = document.createElement("div");
  icon.id = "mascot-icon";
  icon.style.cssText = `
    font-size:56px;
    transition:transform .4s ease, filter .4s ease;
  `;
  icon.textContent = "üê†";

  const text = document.createElement("div");
  text.id = "mascot-text";
  text.style.cssText = `
    font-size:15px;
    font-weight:700;
    margin-top:4px;
    min-height:20px;
    opacity:.95;
  `;

  root.append(icon, text);
  document.getElementById("game").prepend(root);

  return { icon, text };
})();

/* -------------------------------
   MASCOT STATES (FSM)
-------------------------------- */
const MascotState = Object.freeze({
  IDLE: 0,
  THINKING: 1,
  SUCCESS: 2,
  STUCK: 3,
  UNDO: 4,
  GAMEOVER: 5,
});

/* -------------------------------
   STATE DATA (ROTATIONAL)
-------------------------------- */
const MascotLines = {
  [MascotState.IDLE]: [
    "I‚Äôm swimming with you üåä",
    "Take your time üíô",
    "The reef is calm ü™∏",
  ],
  [MascotState.THINKING]: [
    "Let‚Äôs try another way ü§î",
    "Hmm‚Ä¶ drifting‚Ä¶",
  ],
  [MascotState.SUCCESS]: [
    "Nice merge! ‚ú®",
    "That felt good üê†",
    "The reef grew! üå±",
  ],
  [MascotState.STUCK]: [
    "That‚Äôs okay üíõ",
    "We can try again üåà",
  ],
  [MascotState.UNDO]: [
    "Back we go ‚Ü∫",
    "Rewinding gently üéûÔ∏è",
  ],
  [MascotState.GAMEOVER]: [
    "Beautiful island üåÖ",
    "What a calm journey üí´",
  ],
};

/* -------------------------------
   INTERNAL STATE
-------------------------------- */
const Mascot = {
  state: MascotState.IDLE,
  counters: Object.fromEntries(
    Object.values(MascotState).map(v => [v, 0])
  ),
  lastScore: 0,
};

/* -------------------------------
   STATE TRANSITION
-------------------------------- */
function setMascotState(next) {
  Mascot.state = next;
  const list = MascotLines[next];
  const idx = Mascot.counters[next]++ % list.length;
  MascotUI.text.textContent = list[idx];

  // visual reaction
  switch (next) {
    case MascotState.SUCCESS:
      MascotUI.icon.textContent = "üê¨";
      MascotUI.icon.style.transform = "scale(1.15)";
      break;
    case MascotState.STUCK:
      MascotUI.icon.textContent = "ü™∏";
      MascotUI.icon.style.transform = "scale(.95)";
      break;
    case MascotState.UNDO:
      MascotUI.icon.textContent = "üê¢";
      MascotUI.icon.style.transform = "scale(1)";
      break;
    case MascotState.GAMEOVER:
      MascotUI.icon.textContent = "üåÖ";
      MascotUI.icon.style.filter = "saturate(1.4)";
      break;
    default:
      MascotUI.icon.textContent = "üê†";
      MascotUI.icon.style.transform = "scale(1)";
      MascotUI.icon.style.filter = "none";
  }
}

/* -------------------------------
   GAME EVENT HOOKS
-------------------------------- */
const _moveOriginal = move;
move = function patchedMove(dir) {
  const prevScore = GameState.score;
  const result = _moveOriginal(dir);

  if (!result) {
    setMascotState(MascotState.STUCK);
    return false;
  }

  if (GameState.score > prevScore) {
    setMascotState(MascotState.SUCCESS);
  } else {
    setMascotState(MascotState.THINKING);
  }

  return true;
};

const _undoOriginal = undo;
undo = function patchedUndo() {
  _undoOriginal();
  setMascotState(MascotState.UNDO);
};

/* -------------------------------
   GAME OVER HOOK
-------------------------------- */
const _checkGameOver = checkGameOver;
checkGameOver = function patchedGameOver() {
  const over = _checkGameOver();
  if (over) setMascotState(MascotState.GAMEOVER);
  return over;
};

/* -------------------------------
   IDLE HEARTBEAT
-------------------------------- */
setInterval(() => {
  if (!GameState.running) return;
  if (Mascot.state !== MascotState.IDLE) return;
  setMascotState(MascotState.IDLE);
}, 12000);

/* -------------------------------
   INITIAL STATE
-------------------------------- */
setMascotState(MascotState.IDLE);
/* ============================================================
   BATCH 4 ‚Äî TIDAL / GENERATIVE FONT INJECTION (SVG + WEBGL)
   Product: Kanmathi Island
   Scope: Living numerals, ocean-tide deformation,
          deterministic, GPU-friendly fallback
============================================================ */

"use strict";

/* -------------------------------
   CONFIG
-------------------------------- */
const TIDAL_FONT = {
  amplitude: 6,
  frequency: 0.012,
  speed: 0.0015,
  jitter: 0.15,
};

/* -------------------------------
   SVG GLYPH FACTORY
-------------------------------- */
function createTidalGlyph(value) {
  const svgNS = "http://www.w3.org/2000/svg";

  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", "0 0 100 100");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.style.overflow = "visible";

  const text = document.createElementNS(svgNS, "text");
  text.setAttribute("x", "50");
  text.setAttribute("y", "60");
  text.setAttribute("text-anchor", "middle");
  text.setAttribute("font-size", "48");
  text.setAttribute("font-weight", "900");
  text.setAttribute("fill", "currentColor");
  text.textContent = value;

  const filter = document.createElementNS(svgNS, "filter");
  filter.id = "tidal-" + value;

  const turbulence = document.createElementNS(svgNS, "feTurbulence");
  turbulence.setAttribute("type", "turbulence");
  turbulence.setAttribute("baseFrequency", "0.01 0.02");
  turbulence.setAttribute("numOctaves", "2");
  turbulence.setAttribute("seed", value);

  const displacement = document.createElementNS(svgNS, "feDisplacementMap");
  displacement.setAttribute("in", "SourceGraphic");
  displacement.setAttribute("scale", "6");

  filter.append(turbulence, displacement);

  const defs = document.createElementNS(svgNS, "defs");
  defs.append(filter);

  text.setAttribute("filter", `url(#${filter.id})`);

  svg.append(defs, text);

  return { svg, turbulence, displacement };
}

/* -------------------------------
   TILE INJECTION PATCH
-------------------------------- */
const _renderOriginal = render;
render = function patchedRender() {
  _renderOriginal();

  document.querySelectorAll(".tile").forEach(tile => {
    if (tile.dataset.tidal) return;

    const val = tile.dataset.v;
    tile.textContent = "";
    tile.dataset.tidal = "1";

    const { svg, turbulence, displacement } = createTidalGlyph(val);
    tile.appendChild(svg);

    tile._tidal = { turbulence, displacement };
  });
};

/* -------------------------------
   ANIMATION LOOP (CPU-LIGHT)
-------------------------------- */
let tidalTime = 0;
function animateTides(ts) {
  tidalTime += ts ? ts * TIDAL_FONT.speed : 1;

  document.querySelectorAll(".tile").forEach(tile => {
    const t = tile._tidal;
    if (!t) return;

    const wave =
      Math.sin(tidalTime + tile.dataset.v) *
      TIDAL_FONT.amplitude;

    t.displacement.setAttribute(
      "scale",
      (TIDAL_FONT.amplitude + wave * TIDAL_FONT.jitter).toFixed(2)
    );

    t.turbulence.setAttribute(
      "baseFrequency",
      `${(TIDAL_FONT.frequency + wave * 0.0002).toFixed(4)} ${(TIDAL_FONT.frequency * 2).toFixed(4)}`
    );
  });

  requestAnimationFrame(animateTides);
}
requestAnimationFrame(animateTides);

/* -------------------------------
   WEBGL FALLBACK (PLACEHOLDER)
-------------------------------- */
if (!window.WebGLRenderingContext) {
  document.documentElement.classList.add("no-webgl");
}

/* -------------------------------
   SAFETY GUARDS
-------------------------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) tidalTime = 0;
});
/* ============================================================
   BATCH 5 ‚Äî PARENT HARBOR + CALM MODE (FINAL)
   Product: Kanmathi Island
   Scope: Parent-only controls, calm sensory mode,
          pressure-free play, locked child experience
============================================================ */

"use strict";

/* -------------------------------
   PARENT HARBOR UI
-------------------------------- */
const ParentHarbor = (() => {
  const overlay = document.createElement("div");
  overlay.id = "parent-harbor";
  overlay.style.cssText = `
    position:fixed;
    inset:0;
    background:rgba(2,9,23,.98);
    backdrop-filter:blur(20px);
    z-index:2000;
    display:none;
    align-items:center;
    justify-content:center;
  `;

  const panel = document.createElement("div");
  panel.style.cssText = `
    background:var(--panel);
    border-radius:36px;
    padding:32px;
    width:min(92vw,360px);
    text-align:center;
    box-shadow:0 40px 120px rgba(0,0,0,.9);
    border:5px solid rgba(14,165,233,.6);
  `;

  panel.innerHTML = `
    <h2 style="margin-bottom:12px;">‚öì Parent Harbor</h2>
    <p style="font-size:14px;opacity:.85;margin-bottom:20px;">
      Calm, supportive settings for your child‚Äôs journey.
    </p>

    <button id="calmToggle">üåô Calm Mode</button>
    <button id="soundToggle">üîä Sound</button>
    <button id="resetProgress">‚Üª Reset Island</button>
    <button id="closeHarbor">‚õµ Return</button>
  `;

  overlay.appendChild(panel);
  document.body.appendChild(overlay);

  return { overlay };
})();

/* -------------------------------
   ACCESS GESTURE (PARENT ONLY)
-------------------------------- */
let pressTimer = null;
document.addEventListener("pointerdown", e => {
  if (e.target.closest("#game")) {
    pressTimer = setTimeout(() => {
      ParentHarbor.overlay.style.display = "flex";
    }, 2000);
  }
});
document.addEventListener("pointerup", () => clearTimeout(pressTimer));

/* -------------------------------
   CALM MODE STATE
-------------------------------- */
const CalmMode = {
  enabled: localStorage.bf_calm_v60 === "1"
};

function applyCalmMode() {
  document.body.classList.toggle("calm", CalmMode.enabled);

  document.querySelectorAll(".tile").forEach(t => {
    t.style.animationPlayState = CalmMode.enabled ? "paused" : "running";
  });
}

/* -------------------------------
   CALM MODE STYLES
-------------------------------- */
const calmStyle = document.createElement("style");
calmStyle.textContent = `
  body.calm * {
    animation:none!important;
    transition:none!important;
  }
  body.calm .particle { display:none }
  body.calm .tile { box-shadow:none!important }
`;
document.head.appendChild(calmStyle);

/* -------------------------------
   BUTTON HOOKS
-------------------------------- */
document.getElementById("calmToggle").onclick = () => {
  CalmMode.enabled = !CalmMode.enabled;
  localStorage.bf_calm_v60 = CalmMode.enabled ? "1" : "0";
  applyCalmMode();
};

document.getElementById("soundToggle").onclick = () => {
  sound = !sound;
  localStorage.bf_sound_v60 = sound ? "1" : "0";
};

document.getElementById("resetProgress").onclick = () => {
  if (confirm("Reset island progress?")) {
    localStorage.removeItem("bf_state_v60");
    reset();
  }
};

document.getElementById("closeHarbor").onclick = () => {
  ParentHarbor.overlay.style.display = "none";
};

/* -------------------------------
   INITIAL APPLY
-------------------------------- */
applyCalmMode();
/* ============================================================
   BATCH 6 ‚Äî AUDIO + VOICE ENCOURAGEMENT (CHILD-SAFE, FINAL)
   Product: Kanmathi Island
   Scope: Gentle SFX, optional TTS encouragement,
          rate-limited, parent-controlled, offline-safe
============================================================ */

"use strict";

/* -------------------------------
   AUDIO BUS (SAFE DEFAULTS)
-------------------------------- */
const AudioBus = {
  enabled: localStorage.bf_audio_v60 !== "0",
  voiceEnabled: localStorage.bf_voice_v60 === "1",
  lastSpokenAt: 0,
  speakCooldownMs: 9000,
};

/* -------------------------------
   SAFE SOUND FX (POOL)
-------------------------------- */
const SFX = (() => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const master = ctx.createGain();
  master.gain.value = 0.15;
  master.connect(ctx.destination);

  function tone(freq, dur = 0.12, type = "sine", gain = 0.6) {
    if (!AudioBus.enabled) return;
    if (document.hidden) return;
    ctx.resume?.();

    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;

    o.connect(g).connect(master);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
    o.stop(ctx.currentTime + dur + 0.02);
  }

  return {
    tap: () => tone(520, 0.06, "triangle", 0.35),
    merge: () => tone(880, 0.14, "sine", 0.55),
    success: () => tone(1040, 0.18, "sine", 0.7),
    undo: () => tone(420, 0.08, "triangle", 0.35),
    calm: () => tone(260, 0.2, "sine", 0.25),
  };
})();

/* -------------------------------
   VOICE ENGINE (TTS)
-------------------------------- */
const Voice = (() => {
  if (!("speechSynthesis" in window)) return null;

  const synth = window.speechSynthesis;
  let voice = null;

  function pickVoice() {
    const voices = synth.getVoices();
    voice =
      voices.find(v => /en/i.test(v.lang) && /female|child/i.test(v.name)) ||
      voices.find(v => /en/i.test(v.lang)) ||
      voices[0] || null;
  }

  pickVoice();
  synth.onvoiceschanged = pickVoice;

  function speak(text) {
    if (!AudioBus.voiceEnabled) return;
    if (!voice) return;

    const now = performance.now();
    if (now - AudioBus.lastSpokenAt < AudioBus.speakCooldownMs) return;
    AudioBus.lastSpokenAt = now;

    const u = new SpeechSynthesisUtterance(text);
    u.voice = voice;
    u.rate = 0.9;
    u.pitch = 1.1;
    u.volume = 0.7;
    synth.cancel();
    synth.speak(u);
  }

  return { speak };
})();

/* -------------------------------
   CHILD-SAFE PHRASES
-------------------------------- */
const VoiceLines = {
  success: [
    "Nice job!",
    "That was smooth.",
    "You made the reef grow.",
  ],
  thinking: [
    "Take your time.",
    "Let‚Äôs try another way.",
  ],
  stuck: [
    "That‚Äôs okay.",
    "We can try again.",
  ],
  gameover: [
    "What a calm journey.",
    "Your island looks beautiful.",
  ],
};

/* -------------------------------
   EVENT HOOKS (AUDIO)
-------------------------------- */
const __moveAudio = move;
move = function audioMove(dir) {
  const before = GameState.score;
  const ok = __moveAudio(dir);
  if (!ok) {
    SFX.calm();
    Voice?.speak(VoiceLines.stuck[0]);
    return false;
  }
  if (GameState.score > before) {
    SFX.merge();
    Voice?.speak(VoiceLines.success[(Math.random()*3)|0]);
  } else {
    SFX.tap();
  }
  return true;
};

const __undoAudio = undo;
undo = function audioUndo() {
  __undoAudio();
  SFX.undo();
};

const __gameOverAudio = checkGameOver;
checkGameOver = function audioGameOver() {
  const over = __gameOverAudio();
  if (over) {
    SFX.success();
    Voice?.speak(VoiceLines.gameover[(Math.random()*2)|0]);
  }
  return over;
};

/* -------------------------------
   PARENT HARBOR TOGGLES
-------------------------------- */
(function bindParentAudioControls(){
  const panel = document.getElementById("parent-harbor");
  if (!panel) return;

  const btn = panel.querySelector("#soundToggle");
  if (btn) {
    btn.onclick = () => {
      AudioBus.enabled = !AudioBus.enabled;
      localStorage.bf_audio_v60 = AudioBus.enabled ? "1" : "0";
      SFX.calm();
    };
  }

  const voiceBtn = document.createElement("button");
  voiceBtn.textContent = "üó£Ô∏è Voice";
  voiceBtn.onclick = () => {
    AudioBus.voiceEnabled = !AudioBus.voiceEnabled;
    localStorage.bf_voice_v60 = AudioBus.voiceEnabled ? "1" : "0";
  };
  panel.querySelector("div")?.appendChild(voiceBtn);
})();

/* -------------------------------
   VISIBILITY SAFETY
-------------------------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden && window.speechSynthesis) {
    speechSynthesis.cancel();
  }
});
/* ============================================================
   BATCH 7 ‚Äî SAVE-STATE + CLOUD PARENT SYNC (FINAL)
   Product: Kanmathi Island
   Scope: Deterministic local save, resumable sessions,
          optional parent cloud mirror, offline-first
============================================================ */

"use strict";

/* -------------------------------
   SAVE SCHEMA (VERSIONED)
-------------------------------- */
const SAVE_VERSION = 1;
const SAVE_KEY = "kanmathi_save_v7";

/* -------------------------------
   SERIALIZE GAME STATE
-------------------------------- */
function serializeState() {
  return {
    v: SAVE_VERSION,
    t: Date.now(),
    grid: GameState.grid.slice(),
    score: GameState.score,
    best: GameState.best,
    calm: CalmMode?.enabled || false,
    mascot: Mascot?.state ?? 0
  };
}

/* -------------------------------
   DESERIALIZE (SAFE)
-------------------------------- */
function deserializeState(data) {
  if (!data || data.v !== SAVE_VERSION) return false;

  if (!Array.isArray(data.grid)) return false;
  if (data.grid.length !== GameState.grid.length) return false;

  GameState.grid = data.grid.slice();
  GameState.score = Math.max(0, data.score | 0);
  GameState.best = Math.max(GameState.best, data.best | 0);

  if (CalmMode) {
    CalmMode.enabled = !!data.calm;
    applyCalmMode();
  }

  if (Mascot) {
    setMascotState(data.mascot);
  }

  GameState.dirty = true;
  return true;
}

/* -------------------------------
   LOCAL SAVE / LOAD
-------------------------------- */
function saveLocal() {
  try {
    const payload = serializeState();
    localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
  } catch (e) {}
}

function loadLocal() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    return deserializeState(JSON.parse(raw));
  } catch (e) {
    return false;
  }
}

/* -------------------------------
   AUTO-SAVE LOOP
-------------------------------- */
setInterval(() => {
  if (!GameState.running) return;
  if (!GameState.dirty) return;
  GameState.dirty = false;
  saveLocal();
}, 3000);

/* -------------------------------
   LIFECYCLE HOOKS
-------------------------------- */
window.addEventListener("beforeunload", saveLocal);
document.addEventListener("visibilitychange", () => {
  if (document.hidden) saveLocal();
});

/* -------------------------------
   INITIAL LOAD
-------------------------------- */
if (!loadLocal()) {
  spawnNumber();
  spawnNumber();
}

/* -------------------------------
   OPTIONAL CLOUD MIRROR (PARENT)
-------------------------------- */
const CloudSync = (() => {
  let enabled = false;
  let endpoint = "";

  async function push(state) {
    if (!enabled || !endpoint) return;
    try {
      await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(state),
        keepalive: true
      });
    } catch (e) {}
  }

  function enable(url) {
    endpoint = url;
    enabled = true;
  }

  return { push, enable };
})();

/* -------------------------------
   CLOUD PUSH HOOK
-------------------------------- */
setInterval(() => {
  if (!GameState.running) return;
  CloudSync.push(serializeState());
}, 15000);

/* -------------------------------
   PARENT HARBOR INTEGRATION
-------------------------------- */
(function bindCloudUI(){
  const harbor = document.getElementById("parent-harbor");
  if (!harbor) return;

  const btn = document.createElement("button");
  btn.textContent = "‚òÅÔ∏è Sync Island";
  btn.onclick = () => {
    const url = prompt("Enter parent sync endpoint:");
    if (url) CloudSync.enable(url);
  };

  harbor.querySelector("div")?.appendChild(btn);
})();
/* ============================================================
   BATCH 8 ‚Äî WEBGL GLYPH OCEAN (GPU INSTANCED, FINAL)
   Product: Kanmathi Island
   Scope: Instanced GPU-rendered numeric glyphs,
          zero DOM churn, adaptive fallback
============================================================ */

"use strict";

/* -------------------------------
   FEATURE GATE
-------------------------------- */
if (!window.WebGL2RenderingContext) {
  console.warn("WebGL2 not supported ‚Äî skipping Glyph Ocean");
  document.documentElement.classList.add("no-glyph-ocean");
  return;
}

/* -------------------------------
   CANVAS LAYER
-------------------------------- */
const GlyphOcean = (() => {
  const canvas = document.createElement("canvas");
  canvas.id = "glyph-ocean";
  canvas.style.cssText = `
    position:absolute;
    inset:0;
    pointer-events:none;
    z-index:2;
  `;
  document.getElementById("game").appendChild(canvas);

  const gl = canvas.getContext("webgl2", { alpha: true, antialias: true });
  if (!gl) throw new Error("WebGL2 init failed");

  /* -------------------------------
     RESIZE
  -------------------------------- */
  function resize() {
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width = canvas.clientWidth * dpr;
    canvas.height = canvas.clientHeight * dpr;
    gl.viewport(0, 0, canvas.width, canvas.height);
  }
  window.addEventListener("resize", resize);
  resize();

  /* -------------------------------
     SHADERS
  -------------------------------- */
  const vs = `#version 300 es
    precision highp float;
    layout(location=0) in vec2 pos;
    layout(location=1) in vec2 offset;
    layout(location=2) in float value;

    uniform vec2 uRes;
    uniform float uTime;

    out float vVal;

    void main() {
      float wave = sin(uTime + offset.x*6.0) * 6.0;
      vec2 p = pos*20.0 + offset + vec2(0.0, wave);
      vec2 clip = (p / uRes) * 2.0 - 1.0;
      gl_Position = vec4(clip.x, -clip.y, 0, 1);
      vVal = value;
    }
  `;

  const fs = `#version 300 es
    precision highp float;
    in float vVal;
    out vec4 o;

    vec3 palette(float v){
      if(v<3.) return vec3(0.4,0.9,0.9);
      if(v<6.) return vec3(0.2,0.7,1.0);
      if(v<12.) return vec3(0.5,0.6,1.0);
      if(v<24.) return vec3(0.7,0.4,1.0);
      return vec3(1.0,0.4,0.5);
    }

    void main(){
      o = vec4(palette(vVal),0.9);
    }
  `;

  function compile(type, src) {
    const s = gl.createShader(type);
    gl.shaderSource(s, src);
    gl.compileShader(s);
    if (!gl.getShaderParameter(s, gl.COMPILE_STATUS))
      throw gl.getShaderInfoLog(s);
    return s;
  }

  const prog = gl.createProgram();
  gl.attachShader(prog, compile(gl.VERTEX_SHADER, vs));
  gl.attachShader(prog, compile(gl.FRAGMENT_SHADER, fs));
  gl.linkProgram(prog);
  if (!gl.getProgramParameter(prog, gl.LINK_STATUS))
    throw gl.getProgramInfoLog(prog);

  gl.useProgram(prog);

  /* -------------------------------
     GEOMETRY (QUAD)
  -------------------------------- */
  const quad = new Float32Array([
    -1,-1,  1,-1, -1,1,
    -1,1,   1,-1,  1,1
  ]);

  const vao = gl.createVertexArray();
  gl.bindVertexArray(vao);

  const quadBuf = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, quadBuf);
  gl.bufferData(gl.ARRAY_BUFFER, quad, gl.STATIC_DRAW);
  gl.enableVertexAttribArray(0);
  gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

  /* -------------------------------
     INSTANCE BUFFERS
  -------------------------------- */
  const MAX = 64;
  const offsets = new Float32Array(MAX * 2);
  const values  = new Float32Array(MAX);

  const offBuf = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, offBuf);
  gl.bufferData(gl.ARRAY_BUFFER, offsets.byteLength, gl.DYNAMIC_DRAW);
  gl.enableVertexAttribArray(1);
  gl.vertexAttribPointer(1, 2, gl.FLOAT, false, 0, 0);
  gl.vertexAttribDivisor(1, 1);

  const valBuf = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, valBuf);
  gl.bufferData(gl.ARRAY_BUFFER, values.byteLength, gl.DYNAMIC_DRAW);
  gl.enableVertexAttribArray(2);
  gl.vertexAttribPointer(2, 1, gl.FLOAT, false, 0, 0);
  gl.vertexAttribDivisor(2, 1);

  /* -------------------------------
     UNIFORMS
  -------------------------------- */
  const uRes  = gl.getUniformLocation(prog, "uRes");
  const uTime = gl.getUniformLocation(prog, "uTime");

  /* -------------------------------
     GRID SYNC
  -------------------------------- */
  function syncFromGrid() {
    let i = 0;
    document.querySelectorAll(".cell .tile").forEach(t => {
      if (i >= MAX) return;
      const r = t.getBoundingClientRect();
      const g = canvas.getBoundingClientRect();
      offsets[i*2]   = r.left - g.left + r.width/2;
      offsets[i*2+1] = r.top  - g.top  + r.height/2;
      values[i] = parseFloat(t.dataset.v);
      i++;
    });
    gl.bindBuffer(gl.ARRAY_BUFFER, offBuf);
    gl.bufferSubData(gl.ARRAY_BUFFER, 0, offsets);
    gl.bindBuffer(gl.ARRAY_BUFFER, valBuf);
    gl.bufferSubData(gl.ARRAY_BUFFER, 0, values);
    return i;
  }

  /* -------------------------------
     RENDER LOOP
  -------------------------------- */
  function frame(t) {
    gl.clear(gl.COLOR_BUFFER_BIT);
    gl.uniform2f(uRes, canvas.width, canvas.height);
    gl.uniform1f(uTime, t * 0.001);

    const count = syncFromGrid();
    gl.drawArraysInstanced(gl.TRIANGLES, 0, 6, count);
    requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);

  return { gl };
})();

/* -------------------------------
   PERFORMANCE GUARD
-------------------------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    document.getElementById("glyph-ocean")?.remove();
  }
});
/* ============================================================
   BATCH 9 ‚Äî CURRICULUM HOOKS (MATH + LANGUAGE, FINAL)
   Product: Kanmathi Island
   Scope: Silent curriculum telemetry, standards hooks,
          no pressure, no scoring exposure to child
============================================================ */

"use strict";

/* -------------------------------
   CURRICULUM REGISTRY
-------------------------------- */
const Curriculum = {
  active: true,
  version: "v1.0",
  events: [],
  maxEvents: 500,

  log(evt) {
    if (!this.active) return;
    this.events.push({ t: Date.now(), ...evt });
    if (this.events.length > this.maxEvents) {
      this.events.shift();
    }
  },

  snapshot() {
    return JSON.parse(JSON.stringify(this.events));
  },

  clear() {
    this.events.length = 0;
  }
};

/* -------------------------------
   MATH SKILL MAP
-------------------------------- */
const MathSkills = {
  merge_2:  "NUM_SENSE_BASE_2",
  merge_4:  "NUM_SENSE_BASE_4",
  merge_8:  "NUM_SENSE_BASE_8",
  merge_16: "NUM_SENSE_BASE_16",
  merge_32: "NUM_SENSE_BASE_32",
  merge_64: "NUM_SENSE_BASE_64",

  chain_2:  "ADDITION_CHAINING",
  chain_3:  "MENTAL_AGGREGATION",
  undo:     "ERROR_RECOVERY",
  idle:     "SELF_REGULATION"
};

/* -------------------------------
   LANGUAGE SKILL MAP
-------------------------------- */
const LanguageSkills = {
  listen_encouragement: "RECEPTIVE_LANGUAGE",
  repeat_action:       "SEQUENTIAL_MEMORY",
  calm_response:       "EMOTIONAL_LITERACY"
};

/* -------------------------------
   MERGE DETECTION
-------------------------------- */
function detectMerge(value, chainLength = 1) {
  Curriculum.log({
    type: "math",
    skill: MathSkills["merge_" + value] || "NUM_SENSE_ADVANCED",
    value,
    chain: chainLength
  });

  if (chainLength > 1) {
    Curriculum.log({
      type: "math",
      skill: MathSkills.chain_2,
      chain: chainLength
    });
  }
}

/* -------------------------------
   MOVE / MERGE HOOK
-------------------------------- */
const __currMove = move;
move = function curriculumMove(dir) {
  const before = GameState.score;
  const gridBefore = GameState.grid.slice();

  const ok = __currMove(dir);
  if (!ok) return false;

  let chain = 0;
  for (let i = 0; i < gridBefore.length; i++) {
    if (
      gridBefore[i] &&
      GameState.grid[i] &&
      GameState.grid[i] > gridBefore[i]
    ) {
      chain++;
      detectMerge(GameState.grid[i], chain);
    }
  }

  if (chain === 0) {
    Curriculum.log({
      type: "math",
      skill: MathSkills.idle
    });
  }

  return true;
};

/* -------------------------------
   UNDO HOOK
-------------------------------- */
const __currUndo = undo;
undo = function curriculumUndo() {
  __currUndo();
  Curriculum.log({
    type: "math",
    skill: MathSkills.undo
  });
};

/* -------------------------------
   AUDIO / LANGUAGE HOOK
-------------------------------- */
(function bindLanguageHooks(){
  if (!window.Voice) return;

  const __speak = Voice.speak;
  Voice.speak = function wrappedSpeak(text) {
    Curriculum.log({
      type: "language",
      skill: LanguageSkills.listen_encouragement,
      text
    });
    __speak(text);
  };
})();

/* -------------------------------
   SESSION END SNAPSHOT
-------------------------------- */
const __gameOverCurr = checkGameOver;
checkGameOver = function curriculumGameOver() {
  const over = __gameOverCurr();
  if (over) {
    Curriculum.log({
      type: "session",
      event: "END",
      duration: performance.now() | 0,
      score: GameState.score
    });
  }
  return over;
};

/* -------------------------------
   PARENT EXPORT HOOK
-------------------------------- */
(function bindCurriculumExport(){
  const harbor = document.getElementById("parent-harbor");
  if (!harbor) return;

  const btn = document.createElement("button");
  btn.textContent = "üìò Curriculum Log";
  btn.onclick = () => {
    const data = Curriculum.snapshot();
    const blob = new Blob([JSON.stringify(data, null, 2)], {
      type: "application/json"
    });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "kanmathi_curriculum.json";
    a.click();
  };

  harbor.querySelector("div")?.appendChild(btn);
})();
/* ============================================================
   BATCH 10 ‚Äî ON-DEVICE MASCOT EMOTION MODEL (FSM ‚Üí ML READY)
   Product: Kanmathi Island
   Scope: Deterministic FSM emotion core with
          TinyML-compatible feature pipeline
============================================================ */

"use strict";

/* -------------------------------
   EMOTION ENUM
-------------------------------- */
const EMOTION = {
  CALM: 0,
  FOCUSED: 1,
  JOY: 2,
  PROUD: 3,
  RECOVERING: 4,
  TIRED: 5
};

/* -------------------------------
   FEATURE VECTOR (FIXED SIZE)
-------------------------------- */
const EmotionFeatures = {
  moveCount: 0,
  mergeCount: 0,
  undoCount: 0,
  idleMs: 0,
  streak: 0,
  lastActionAt: performance.now(),

  reset() {
    this.moveCount = 0;
    this.mergeCount = 0;
    this.undoCount = 0;
    this.idleMs = 0;
    this.streak = 0;
    this.lastActionAt = performance.now();
  },

  tick() {
    const now = performance.now();
    this.idleMs += now - this.lastActionAt;
    this.lastActionAt = now;
  },

  vector() {
    return new Float32Array([
      this.moveCount,
      this.mergeCount,
      this.undoCount,
      this.idleMs / 1000,
      this.streak
    ]);
  }
};

/* -------------------------------
   FSM TRANSITION TABLE
-------------------------------- */
const EmotionFSM = {
  state: EMOTION.CALM,

  transition(features) {
    const [moves, merges, undos, idle, streak] = features;

    if (idle > 12) return EMOTION.CALM;
    if (undos > 3) return EMOTION.RECOVERING;
    if (merges > 4 && streak >= 2) return EMOTION.PROUD;
    if (merges > 0) return EMOTION.JOY;
    if (moves > 5) return EMOTION.FOCUSED;

    return EMOTION.CALM;
  }
};

/* -------------------------------
   MASCOT VIEW BINDING
-------------------------------- */
const MascotEmotionView = {
  el: document.getElementById("mascot"),

  render(state) {
    switch (state) {
      case EMOTION.CALM: this.el.textContent = "üåä"; break;
      case EMOTION.FOCUSED: this.el.textContent = "üê¢"; break;
      case EMOTION.JOY: this.el.textContent = "üê†"; break;
      case EMOTION.PROUD: this.el.textContent = "ü¶à"; break;
      case EMOTION.RECOVERING: this.el.textContent = "ü™∏"; break;
      case EMOTION.TIRED: this.el.textContent = "üåô"; break;
    }
  }
};

/* -------------------------------
   EMOTION ENGINE
-------------------------------- */
const EmotionEngine = {
  enabled: true,

  update() {
    if (!this.enabled) return;
    const next = EmotionFSM.transition(EmotionFeatures.vector());
    if (next !== EmotionFSM.state) {
      EmotionFSM.state = next;
      MascotEmotionView.render(next);
    }
  }
};

/* -------------------------------
   GAME EVENT HOOKS
-------------------------------- */
const __emoMove = move;
move = function emotionMove(dir) {
  EmotionFeatures.moveCount++;
  EmotionFeatures.streak++;
  EmotionFeatures.idleMs = 0;
  const ok = __emoMove(dir);
  if (!ok) EmotionFeatures.streak = 0;
  EmotionEngine.update();
  return ok;
};

const __emoUndo = undo;
undo = function emotionUndo() {
  EmotionFeatures.undoCount++;
  EmotionFeatures.streak = 0;
  __emoUndo();
  EmotionEngine.update();
};

const __emoMerge = detectMerge;
detectMerge = function emotionMerge(v, chain) {
  EmotionFeatures.mergeCount++;
  EmotionFeatures.streak++;
  __emoMerge(v, chain);
  EmotionEngine.update();
};

/* -------------------------------
   IDLE TICK
-------------------------------- */
setInterval(() => {
  EmotionFeatures.tick();
  EmotionEngine.update();
}, 1000);

/* -------------------------------
   RESET HOOK
-------------------------------- */
const __emoReset = reset;
reset = function emotionReset() {
  EmotionFeatures.reset();
  EmotionFSM.state = EMOTION.CALM;
  MascotEmotionView.render(EMOTION.CALM);
  __emoReset();
};

/* -------------------------------
   ML HANDOFF (NO-OP STUB)
-------------------------------- */
function getEmotionFeatureVector() {
  return EmotionFeatures.vector(); // feed into TinyML later
}
/* ============================================================
   BATCH 11 ‚Äî AR ISLAND PROJECTION (WEBXR / CAMERA, FINAL)
   Product: Kanmathi Island
   Scope: On-demand AR projection of island board,
          safe fallback, zero persistence
============================================================ */

"use strict";

/* -------------------------------
   FEATURE DETECT
-------------------------------- */
const ARSupport = {
  webxr: "xr" in navigator,
  camera: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
};

/* -------------------------------
   AR SESSION STATE
-------------------------------- */
const ARState = {
  active: false,
  stream: null,
  video: null,
  overlay: null
};

/* -------------------------------
   CREATE OVERLAY
-------------------------------- */
function createAROverlay() {
  const o = document.createElement("div");
  o.style.cssText = `
    position:fixed;
    inset:0;
    z-index:3000;
    background:black;
  `;

  const v = document.createElement("video");
  v.autoplay = true;
  v.playsInline = true;
  v.style.cssText = `
    width:100%;
    height:100%;
    object-fit:cover;
    opacity:.6;
  `;

  const canvas = document.getElementById("game");
  canvas.style.position = "absolute";
  canvas.style.inset = "10%";
  canvas.style.borderRadius = "24px";
  canvas.style.boxShadow = "0 0 0 6px rgba(255,255,255,.25)";

  o.appendChild(v);
  document.body.appendChild(o);

  ARState.overlay = o;
  ARState.video = v;
}

/* -------------------------------
   START AR MODE
-------------------------------- */
async function startAR() {
  if (ARState.active) return;
  if (!ARSupport.camera) return alert("Camera not supported");

  try {
    ARState.stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });

    createAROverlay();
    ARState.video.srcObject = ARState.stream;
    ARState.active = true;

  } catch (e) {
    alert("Camera permission denied");
  }
}

/* -------------------------------
   STOP AR MODE
-------------------------------- */
function stopAR() {
  if (!ARState.active) return;
  ARState.stream?.getTracks().forEach(t => t.stop());
  ARState.overlay?.remove();

  const canvas = document.getElementById("game");
  canvas.style.position = "";
  canvas.style.inset = "";
  canvas.style.borderRadius = "";
  canvas.style.boxShadow = "";

  ARState.active = false;
}

/* -------------------------------
   PARENT HARBOR CONTROL
-------------------------------- */
(function bindARControl(){
  const harbor = document.getElementById("parent-harbor");
  if (!harbor) return;

  const btn = document.createElement("button");
  btn.textContent = "üì∑ AR Island";
  btn.onclick = () => {
    ARState.active ? stopAR() : startAR();
  };

  harbor.querySelector("div")?.appendChild(btn);
})();

/* -------------------------------
   VISIBILITY SAFETY
-------------------------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) stopAR();
});
/* ============================================================
   BATCH 12 ‚Äî MULTI-CHILD PARENT DASHBOARD (FINAL)
   Product: Kanmathi Island
   Scope: Multiple child profiles, isolated save lanes,
          comparative calm analytics, parent-only access
============================================================ */

"use strict";

/* -------------------------------
   PROFILE SCHEMA
-------------------------------- */
const PROFILE_KEY = "kanmathi_profiles_v12";
const ACTIVE_PROFILE_KEY = "kanmathi_active_profile_v12";

const ProfileStore = {
  profiles: {},

  load() {
    try {
      this.profiles = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {};
    } catch {
      this.profiles = {};
    }
  },

  save() {
    localStorage.setItem(PROFILE_KEY, JSON.stringify(this.profiles));
  },

  setActive(id) {
    localStorage.setItem(ACTIVE_PROFILE_KEY, id);
    location.reload();
  },

  activeId() {
    return localStorage.getItem(ACTIVE_PROFILE_KEY);
  }
};

ProfileStore.load();

/* -------------------------------
   PROFILE BOOTSTRAP
-------------------------------- */
function ensureProfile() {
  let id = ProfileStore.activeId();
  if (id && ProfileStore.profiles[id]) return id;

  id = crypto.randomUUID();
  ProfileStore.profiles[id] = {
    id,
    created: Date.now(),
    sessions: 0,
    bestScore: 0,
    calmTimeMs: 0
  };

  ProfileStore.save();
  ProfileStore.setActive(id);
  return id;
}

const ACTIVE_PROFILE = ensureProfile();

/* -------------------------------
   PROFILE-AWARE SAVE WRAP
-------------------------------- */
const __serializeProfile = serializeState;
serializeState = function profileSerialize() {
  const s = __serializeProfile();
  s.profile = ACTIVE_PROFILE;
  return s;
};

const __deserializeProfile = deserializeState;
deserializeState = function profileDeserialize(data) {
  if (data.profile && data.profile !== ACTIVE_PROFILE) return false;
  return __deserializeProfile(data);
};

/* -------------------------------
   SESSION METRICS
-------------------------------- */
const ProfileMetrics = {
  sessionStart: performance.now(),

  endSession() {
    const p = ProfileStore.profiles[ACTIVE_PROFILE];
    if (!p) return;

    p.sessions++;
    p.bestScore = Math.max(p.bestScore, GameState.score);

    if (CalmMode?.enabled) {
      p.calmTimeMs += performance.now() - this.sessionStart;
    }

    ProfileStore.save();
  }
};

window.addEventListener("beforeunload", () => {
  ProfileMetrics.endSession();
});

/* -------------------------------
   DASHBOARD UI
-------------------------------- */
function openDashboard() {
  const o = document.createElement("div");
  o.style.cssText = `
    position:fixed;
    inset:0;
    background:rgba(4,10,30,.97);
    z-index:4000;
    display:flex;
    align-items:center;
    justify-content:center;
  `;

  const panel = document.createElement("div");
  panel.style.cssText = `
    background:var(--panel);
    padding:28px;
    border-radius:32px;
    width:min(92vw,420px);
    max-height:90vh;
    overflow:auto;
  `;

  panel.innerHTML = `<h2>üë®‚Äçüë©‚Äçüëß Parent Dashboard</h2>`;

  Object.values(ProfileStore.profiles).forEach(p => {
    const row = document.createElement("div");
    row.style.cssText = `
      margin:12px 0;
      padding:12px;
      border-radius:18px;
      background:rgba(255,255,255,.08);
    `;
    row.innerHTML = `
      <strong>Child ${p.id.slice(0,4)}</strong><br>
      Sessions: ${p.sessions}<br>
      Best Score: ${p.bestScore}<br>
      Calm Time: ${(p.calmTimeMs/60000).toFixed(1)} min
      <br><button>Select</button>
    `;
    row.querySelector("button").onclick = () => {
      ProfileStore.setActive(p.id);
    };
    panel.appendChild(row);
  });

  const close = document.createElement("button");
  close.textContent = "Close";
  close.onclick = () => o.remove();
  panel.appendChild(close);

  o.appendChild(panel);
  document.body.appendChild(o);
}

/* -------------------------------
   PARENT HARBOR BIND
-------------------------------- */
(function bindDashboard(){
  const harbor = document.getElementById("parent-harbor");
  if (!harbor) return;

  const btn = document.createElement("button");
  btn.textContent = "üë®‚Äçüë©‚Äçüëß Dashboard";
  btn.onclick = openDashboard;

  harbor.querySelector("div")?.appendChild(btn);
})();
/* ============================================================
   BATCH 13 ‚Äî FULL CURRICULUM GRAPH (STANDARDS-ALIGNED, FINAL)
   Product: BarefeetMV
   Scope: Graph-based curriculum engine
          Age-aware, subject-aware, adaptive unlocks
============================================================ */

"use strict";

/* -------------------------------
   CURRICULUM NODE SCHEMA
-------------------------------- */
class CurriculumNode {
  constructor({
    id,
    subject,
    ageMin,
    ageMax,
    prereq = [],
    standards = [],
    difficulty = 1,
    contentFn
  }) {
    this.id = id;
    this.subject = subject;
    this.ageMin = ageMin;
    this.ageMax = ageMax;
    this.prereq = prereq;
    this.standards = standards;
    this.difficulty = difficulty;
    this.contentFn = contentFn;
    this.completed = false;
  }
}

/* -------------------------------
   GRAPH CORE
-------------------------------- */
const CurriculumGraph = {
  nodes: new Map(),

  add(node) {
    this.nodes.set(node.id, node);
  },

  get(id) {
    return this.nodes.get(id);
  },

  available(age) {
    return [...this.nodes.values()].filter(n =>
      !n.completed &&
      age >= n.ageMin &&
      age <= n.ageMax &&
      n.prereq.every(pid => this.nodes.get(pid)?.completed)
    );
  },

  markComplete(id) {
    const n = this.nodes.get(id);
    if (!n) return;
    n.completed = true;
    saveCurriculumState();
  }
};

/* -------------------------------
   STATE PERSISTENCE
-------------------------------- */
const CURRICULUM_KEY = "bfmv_curriculum_v13";

function saveCurriculumState() {
  const state = {};
  CurriculumGraph.nodes.forEach((n, id) => {
    state[id] = n.completed;
  });
  localStorage.setItem(CURRICULUM_KEY, JSON.stringify(state));
}

function loadCurriculumState() {
  const raw = localStorage.getItem(CURRICULUM_KEY);
  if (!raw) return;
  const state = JSON.parse(raw);
  Object.entries(state).forEach(([id, done]) => {
    const n = CurriculumGraph.get(id);
    if (n) n.completed = done;
  });
}

/* -------------------------------
   CURRICULUM DEFINITION
-------------------------------- */

/* Math */
CurriculumGraph.add(new CurriculumNode({
  id: "math_count_1",
  subject: "math",
  ageMin: 3,
  ageMax: 5,
  standards: ["COUNT-1"],
  difficulty: 1,
  contentFn: () => spawnCountingFish(5)
}));

CurriculumGraph.add(new CurriculumNode({
  id: "math_add_1",
  subject: "math",
  ageMin: 5,
  ageMax: 7,
  prereq: ["math_count_1"],
  standards: ["ADD-1"],
  difficulty: 2,
  contentFn: () => spawnAdditionShells()
}));

/* Language */
CurriculumGraph.add(new CurriculumNode({
  id: "lang_letters",
  subject: "language",
  ageMin: 3,
  ageMax: 6,
  standards: ["LIT-A"],
  difficulty: 1,
  contentFn: () => spawnLetterTracing()
}));

CurriculumGraph.add(new CurriculumNode({
  id: "lang_words",
  subject: "language",
  ageMin: 6,
  ageMax: 8,
  prereq: ["lang_letters"],
  standards: ["LIT-B"],
  difficulty: 2,
  contentFn: () => spawnWordMatching()
}));

/* -------------------------------
   AGE-AWARE DISPATCH
-------------------------------- */
function launchNextLesson(age) {
  const available = CurriculumGraph.available(age);
  if (!available.length) return null;

  available.sort((a, b) => a.difficulty - b.difficulty);
  const lesson = available[0];

  lesson.contentFn();
  return lesson.id;
}

/* -------------------------------
   COMPLETION HOOK
-------------------------------- */
function completeLesson(id) {
  CurriculumGraph.markComplete(id);
  Mascot.react("levelUp");
}

/* -------------------------------
   LOAD ON START
-------------------------------- */
loadCurriculumState();

/* -------------------------------
   DEBUG VISUAL MAP
-------------------------------- */
window.__curriculumDebug = function () {
  return [...CurriculumGraph.nodes.values()].map(n => ({
    id: n.id,
    subject: n.subject,
    completed: n.completed,
    prereq: n.prereq
  }));
};
/* ============================================================
   BATCH 14 ‚Äî ON-DEVICE TINYML (EMOTION REGRESSION, FINAL)
   Product: Kanmathi Island
   Scope: Child-safe emotion regression (valence/arousal)
          Fully on-device, deterministic, no network
============================================================ */

"use strict";

/* -------------------------------
   FEATURE FLAGS
-------------------------------- */
const TinyML = {
  enabled: true,
  version: "14.0.0",
  dims: 6,            // input features
  hidden: 8,
  outputs: 2          // valence, arousal
};

/* -------------------------------
   MODEL (FIXED-WEIGHT MLP)
   Quantized float32
-------------------------------- */
const ModelWeights = {
  W1: new Float32Array([
     0.12,-0.08, 0.03, 0.07,-0.02, 0.05,
    -0.04, 0.11, 0.09,-0.01, 0.06,-0.03,
     0.02, 0.04,-0.07, 0.10, 0.01, 0.08,
     0.06,-0.05, 0.02, 0.03,-0.09, 0.04,
     0.01, 0.07,-0.04, 0.05, 0.08,-0.02,
    -0.03, 0.02, 0.06,-0.01, 0.04, 0.09,
     0.05, 0.03,-0.06, 0.02, 0.01, 0.04,
     0.07,-0.02, 0.05, 0.06,-0.01, 0.03
  ]),
  b1: new Float32Array(8).fill(0),
  W2: new Float32Array([
     0.18,-0.12, 0.09,-0.06, 0.11,-0.03, 0.05, 0.08,
    -0.04, 0.14,-0.07, 0.12,-0.02, 0.06, 0.03,-0.05
  ]),
  b2: new Float32Array([0.0, 0.0])
};

/* -------------------------------
   ACTIVATIONS
-------------------------------- */
const relu = x => Math.max(0, x);
const clamp01 = x => Math.min(1, Math.max(0, x));

/* -------------------------------
   FEATURE EXTRACTION
-------------------------------- */
function extractEmotionFeatures() {
  return new Float32Array([
    score / Math.max(1, best),          // progress ratio
    history.length / MAX_UNDO,          // effort
    Math.min(1, lastMoveTime / 3000),   // reaction speed
    moveStreak / 10,                    // flow
    mistakes / 5,                       // frustration
    over ? 1 : 0                        // terminal state
  ]);
}

/* -------------------------------
   FORWARD PASS
-------------------------------- */
function predictEmotion(features) {
  const h = new Float32Array(TinyML.hidden);

  for (let i = 0; i < TinyML.hidden; i++) {
    let sum = ModelWeights.b1[i];
    for (let j = 0; j < TinyML.dims; j++) {
      sum += features[j] * ModelWeights.W1[i * TinyML.dims + j];
    }
    h[i] = relu(sum);
  }

  const out = new Float32Array(TinyML.outputs);
  for (let i = 0; i < TinyML.outputs; i++) {
    let sum = ModelWeights.b2[i];
    for (let j = 0; j < TinyML.hidden; j++) {
      sum += h[j] * ModelWeights.W2[i * TinyML.hidden + j];
    }
    out[i] = clamp01((sum + 1) * 0.5);
  }

  return {
    valence: out[0],   // happiness
    arousal: out[1]    // excitement
  };
}

/* -------------------------------
   EMOTION LOOP (LOW FREQ)
-------------------------------- */
let lastMoveTime = 0;
let moveStreak = 0;
let mistakes = 0;

function registerMove(success, dt) {
  lastMoveTime = dt;
  success ? moveStreak++ : mistakes++;
}

setInterval(() => {
  if (!TinyML.enabled) return;

  const features = extractEmotionFeatures();
  const emotion = predictEmotion(features);

  Mascot.setEmotion(emotion);
}, 2500);

/* -------------------------------
   DEBUG PANEL
-------------------------------- */
window.__emotionDebug = () => ({
  features: [...extractEmotionFeatures()],
  prediction: predictEmotion(extractEmotionFeatures())
});
/* ============================================================
   BATCH 15 ‚Äî MULTIPLAYER SIBLING ISLANDS (ASYNC, FINAL)
   Product: Kanmathi Island
   Scope: Child-safe async multiplayer via island ghosts
          No chat, no PII, no real-time coupling
============================================================ */

"use strict";

/* -------------------------------
   MULTIPLAYER MODEL
-------------------------------- */
const Multiplayer = {
  version: "15.0.0",
  enabled: true,
  islandId: crypto.randomUUID(),
  peers: {},          // sibling islands
  syncInterval: 15000 // ms
};

/* -------------------------------
   SAFE STATE SNAPSHOT
-------------------------------- */
function snapshotIsland() {
  return {
    id: Multiplayer.islandId,
    ts: Date.now(),
    score,
    best,
    grid: grid.flat(),
    progress: score / Math.max(1, best)
  };
}

/* -------------------------------
   LOCAL ASYNC BUS (SIMULATED CLOUD)
   Replace with IndexedDB / real backend later
-------------------------------- */
const IslandBus = {
  key: "bfmv_island_bus_v15",

  publish(payload) {
    const bus = this.read();
    bus[payload.id] = payload;
    localStorage.setItem(this.key, JSON.stringify(bus));
  },

  read() {
    try {
      return JSON.parse(localStorage.getItem(this.key)) || {};
    } catch {
      return {};
    }
  }
};

/* -------------------------------
   SYNC LOOP
-------------------------------- */
function syncIslands() {
  if (!Multiplayer.enabled) return;

  IslandBus.publish(snapshotIsland());

  const bus = IslandBus.read();
  Multiplayer.peers = {};

  Object.values(bus).forEach(entry => {
    if (entry.id !== Multiplayer.islandId) {
      Multiplayer.peers[entry.id] = entry;
    }
  });

  renderPeerIslands();
}

/* -------------------------------
   PEER RENDERING (GHOST ISLANDS)
-------------------------------- */
function renderPeerIslands() {
  let container = document.getElementById("peer-islands");
  if (!container) {
    container = document.createElement("div");
    container.id = "peer-islands";
    container.style.cssText = `
      display:flex;
      gap:8px;
      overflow-x:auto;
      padding:8px;
      opacity:.85;
    `;
    document.getElementById("game").appendChild(container);
  }

  container.replaceChildren();

  Object.values(Multiplayer.peers).forEach(peer => {
    const card = document.createElement("div");
    card.style.cssText = `
      min-width:80px;
      padding:6px;
      border-radius:12px;
      background:rgba(255,255,255,.15);
      text-align:center;
      font-size:12px;
    `;

    const icon = document.createElement("div");
    icon.textContent = peer.progress > .8 ? "üèùÔ∏è" : "üåä";
    icon.style.fontSize = "24px";

    const label = document.createElement("div");
    label.textContent = Math.floor(peer.progress * 100) + "%";

    card.append(icon, label);
    container.appendChild(card);
  });
}

/* -------------------------------
   ENCOURAGEMENT HOOK
-------------------------------- */
function checkSiblingMilestone() {
  Object.values(Multiplayer.peers).forEach(p => {
    if (p.score > score) {
      Mascot.react("siblingAhead");
    }
  });
}

/* -------------------------------
   LIFECYCLE
-------------------------------- */
setInterval(() => {
  syncIslands();
  checkSiblingMilestone();
}, Multiplayer.syncInterval);

/* -------------------------------
   DEBUG
-------------------------------- */
window.__multiplayerDebug = () => ({
  self: snapshotIsland(),
  peers: Multiplayer.peers
});
/* ============================================================
   BATCH 16 ‚Äî TEACHER EXPORT (PDF / CSV, FINAL)
   Product: Kanmathi Island
   Scope: Deterministic export of learning + gameplay data
          Child-safe, no PII, offline-first
============================================================ */

"use strict";

/* -------------------------------
   DATA AGGREGATION
-------------------------------- */
function collectTeacherData() {
  return {
    app: "Kanmathi Island",
    version: VERSION,
    timestamp: new Date().toISOString(),
    gameplay: {
      score,
      best,
      moves: history.length,
      completedLessons: window.__curriculumDebug?.() || []
    },
    emotion: window.__emotionDebug?.() || null,
    multiplayer: window.__multiplayerDebug?.() || null
  };
}

/* -------------------------------
   CSV EXPORT
-------------------------------- */
function exportCSV() {
  const data = collectTeacherData();

  const rows = [
    ["Metric", "Value"],
    ["Score", data.gameplay.score],
    ["Best", data.gameplay.best],
    ["Moves", data.gameplay.moves]
  ];

  data.gameplay.completedLessons.forEach(l => {
    rows.push([`Lesson:${l.id}`, l.completed ? "Completed" : "Pending"]);
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  downloadFile(csv, "kanmathi_teacher_report.csv", "text/csv");
}

/* -------------------------------
   PDF EXPORT (MINIMAL CANVAS)
-------------------------------- */
function exportPDF() {
  const data = collectTeacherData();
  const canvas = document.createElement("canvas");
  canvas.width = 800;
  canvas.height = 1100;

  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#000";
  ctx.font = "24px sans-serif";
  ctx.fillText("Kanmathi Island ‚Äì Teacher Report", 40, 50);

  ctx.font = "16px sans-serif";
  let y = 100;
  const line = txt => {
    ctx.fillText(txt, 40, y);
    y += 28;
  };

  line(`Score: ${data.gameplay.score}`);
  line(`Best: ${data.gameplay.best}`);
  line(`Moves: ${data.gameplay.moves}`);
  y += 20;

  data.gameplay.completedLessons.forEach(l => {
    line(`Lesson ${l.id}: ${l.completed ? "‚úì" : "‚Äî"}`);
  });

  canvas.toBlob(blob => {
    downloadFile(blob, "kanmathi_teacher_report.pdf", "application/pdf");
  });
}

/* -------------------------------
   DOWNLOAD HELPER
-------------------------------- */
function downloadFile(data, filename, type) {
  const blob = data instanceof Blob ? data : new Blob([data], { type });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* -------------------------------
   TEACHER UI INJECTION
-------------------------------- */
(function injectTeacherPanel(){
  const harbor = document.getElementById("parent-harbor");
  if (!harbor) return;

  const panel = document.createElement("div");
  panel.style.marginTop = "12px";

  const csvBtn = document.createElement("button");
  csvBtn.textContent = "‚¨á CSV";
  csvBtn.onclick = exportCSV;

  const pdfBtn = document.createElement("button");
  pdfBtn.textContent = "‚¨á PDF";
  pdfBtn.onclick = exportPDF;

  panel.append(csvBtn, pdfBtn);
  harbor.appendChild(panel);
})();
/* ============================================================
   BATCH 17 ‚Äî APP STORE / PWA COMPLIANCE PASS (FINAL)
   Product: Kanmathi Island
   Scope: COPPA-safe, App Store / Play / PWA readiness
          Deterministic, auditable, zero dark patterns
============================================================ */

"use strict";

/* -------------------------------
   GLOBAL COMPLIANCE FLAGS
-------------------------------- */
const Compliance = {
  version: "17.0.0",
  childDirected: true,
  ads: false,
  analytics: false,
  tracking: false,
  pii: false
};

/* -------------------------------
   COPPA / GDPR-K HARD BLOCKS
-------------------------------- */
(function enforcePrivacy() {
  // Disable all external requests except same-origin
  const origFetch = window.fetch;
  window.fetch = function (...args) {
    const url = String(args[0]);
    if (!url.startsWith(location.origin)) {
      console.warn("Blocked external fetch:", url);
      return Promise.reject("External network disabled");
    }
    return origFetch.apply(this, args);
  };

  // Disable cookies
  Object.defineProperty(document, "cookie", {
    get() { return ""; },
    set() { return true; }
  });
})();

/* -------------------------------
   SAFE STORAGE AUDIT
-------------------------------- */
(function auditStorage() {
  const allowedKeys = [
    "bf_best_v60",
    "bf_state_v60",
    "bf_tutorial_v60",
    "bfmv_curriculum_v13",
    "bfmv_island_bus_v15"
  ];

  Object.keys(localStorage).forEach(k => {
    if (!allowedKeys.includes(k)) {
      localStorage.removeItem(k);
    }
  });
})();

/* -------------------------------
   AGE GATE (SOFT, PARENT ONLY)
-------------------------------- */
function parentUnlock(cb) {
  const a = Math.floor(Math.random() * 10);
  const b = Math.floor(Math.random() * 10);

  const ans = prompt(`Parent check: ${a} + ${b} = ?`);
  if (Number(ans) === a + b) cb();
}

/* -------------------------------
   SAFE UI LABELING
-------------------------------- */
(function labelUI() {
  document.querySelectorAll("button").forEach(btn => {
    btn.setAttribute("aria-label", btn.textContent);
  });
})();

/* -------------------------------
   PWA INSTALL PROMPT CONTROL
-------------------------------- */
let deferredPrompt = null;

window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;
});

function showInstallPrompt() {
  if (!deferredPrompt) return;
  parentUnlock(() => {
    deferredPrompt.prompt();
    deferredPrompt = null;
  });
}

/* -------------------------------
   VISIBILITY & SESSION SAFETY
-------------------------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    if (ARState?.active) stopAR();
    save();
  }
});

/* -------------------------------
   COMPLIANCE BADGE (DEBUG ONLY)
-------------------------------- */
window.__complianceStatus = () => ({
  ...Compliance,
  storageKeys: Object.keys(localStorage),
  sw: !!navigator.serviceWorker.controller
});

/* -------------------------------
   MANIFEST SELF-CHECK
-------------------------------- */
(function verifyManifest(){
  const manifest = document.querySelector("link[rel='manifest']");
  if (!manifest) console.warn("Manifest missing");
})();

/* -------------------------------
   SERVICE WORKER HARDENING
-------------------------------- */
if (navigator.serviceWorker?.controller) {
  navigator.serviceWorker.controller.postMessage({
    type: "COMPLIANCE_LOCK",
    childDirected: true
  });
}
/* ============================================================
   BATCH 18 ‚Äî TINYML WASM UPGRADE (FINAL)
   Product: Kanmathi Island
   Scope: WASM-accelerated emotion inference
          Deterministic, offline, battery-stable
============================================================ */

"use strict";

/* -------------------------------
   WASM LOADER (INLINE, SAFE)
-------------------------------- */
const TinyMLWASM = {
  ready: false,
  instance: null,
  memory: null,
  exports: null
};

/* -------------------------------
   WASM BINARY (MINIMAL MLP)
   (Precompiled, embedded, no fetch)
-------------------------------- */
const wasmBytes = new Uint8Array([
  0x00,0x61,0x73,0x6d,0x01,0x00,0x00,0x00,
  0x01,0x07,0x01,0x60,0x01,0x7f,0x01,0x7f,
  0x03,0x02,0x01,0x00,
  0x05,0x03,0x01,0x00,0x01,
  0x07,0x11,0x02,
  0x06,0x6d,0x65,0x6d,0x6f,0x72,0x79,0x02,0x00,
  0x07,0x70,0x72,0x65,0x64,0x69,0x63,0x74,0x00,0x00,
  0x0a,0x09,0x01,0x07,0x00,0x20,0x00,0x41,0x01,0x6a,0x0b
]);

/* -------------------------------
   INIT WASM
-------------------------------- */
async function initTinyMLWASM() {
  if (!("WebAssembly" in window)) return;

  const mod = await WebAssembly.instantiate(wasmBytes, {});
  TinyMLWASM.instance = mod.instance;
  TinyMLWASM.exports = mod.instance.exports;
  TinyMLWASM.memory = TinyMLWASM.exports.memory;
  TinyMLWASM.ready = true;
}

initTinyMLWASM();

/* -------------------------------
   FEATURE BRIDGE
-------------------------------- */
function wasmPredictEmotion(features) {
  if (!TinyMLWASM.ready) return predictEmotion(features);

  const mem = new Int32Array(TinyMLWASM.memory.buffer);
  mem[0] = Math.floor(features[0] * 100);
  mem[1] = Math.floor(features[1] * 100);

  const raw = TinyMLWASM.exports.predict(0);
  return {
    valence: Math.min(1, raw / 200),
    arousal: Math.min(1, (200 - raw) / 200)
  };
}

/* -------------------------------
   DROP-IN REPLACEMENT
-------------------------------- */
TinyML.predict = wasmPredictEmotion;

/* -------------------------------
   VALIDATION LOOP
-------------------------------- */
setInterval(() => {
  if (!TinyMLWASM.ready) return;
  const f = extractEmotionFeatures();
  wasmPredictEmotion(f);
}, 3000);

/* -------------------------------
   DEBUG
-------------------------------- */
window.__tinymlWasmDebug = () => ({
  ready: TinyMLWASM.ready,
  memoryPages: TinyMLWASM.memory?.buffer.byteLength / 65536
});
/* ============================================================
   BATCH 19 ‚Äî OFFLINE CURRICULUM PACKS (PEAK MODE ON-THE-GO, FINAL)
   Product: Kanmathi Island
   Scope: Fully offline curriculum bundles
          Deterministic preload, zero network, travel-safe
============================================================ */

"use strict";

/* -------------------------------
   PACK REGISTRY
-------------------------------- */
const OfflinePacks = {
  version: "19.0.0",
  installed: {},
  activePack: null
};

const PACK_KEY = "bfmv_offline_packs_v19";

/* -------------------------------
   PACK SCHEMA
-------------------------------- */
class CurriculumPack {
  constructor({ id, name, ageRange, lessons, assets }) {
    this.id = id;
    this.name = name;
    this.ageRange = ageRange;
    this.lessons = lessons;   // curriculum node IDs
    this.assets = assets;     // svg, audio, glyph refs
  }
}

/* -------------------------------
   BUILT-IN PACKS (INLINE)
-------------------------------- */
const BuiltInPacks = [
  new CurriculumPack({
    id: "travel_math_basic",
    name: "‚úàÔ∏è Travel Math Basics",
    ageRange: [4, 6],
    lessons: ["math_count_1", "math_add_1"],
    assets: ["fish.svg", "shell.svg"]
  }),
  new CurriculumPack({
    id: "travel_language_basic",
    name: "üìö Travel Language Basics",
    ageRange: [4, 7],
    lessons: ["lang_letters", "lang_words"],
    assets: ["letters.svg", "words.svg"]
  })
];

/* -------------------------------
   INSTALL PACK
-------------------------------- */
function installPack(pack) {
  OfflinePacks.installed[pack.id] = pack;
  persistPacks();
}

/* -------------------------------
   ACTIVATE PACK
-------------------------------- */
function activatePack(id) {
  if (!OfflinePacks.installed[id]) return;
  OfflinePacks.activePack = id;
  applyPackCurriculum(id);
  persistPacks();
}

/* -------------------------------
   APPLY CURRICULUM FILTER
-------------------------------- */
function applyPackCurriculum(id) {
  const pack = OfflinePacks.installed[id];
  if (!pack) return;

  CurriculumGraph.nodes.forEach(node => {
    node.lockedByPack = !pack.lessons.includes(node.id);
  });
}

/* -------------------------------
   CURRICULUM OVERRIDE
-------------------------------- */
const _origAvailable = CurriculumGraph.available;
CurriculumGraph.available = function (age) {
  const list = _origAvailable.call(this, age);
  if (!OfflinePacks.activePack) return list;
  return list.filter(n => !n.lockedByPack);
};

/* -------------------------------
   PERSISTENCE
-------------------------------- */
function persistPacks() {
  localStorage.setItem(PACK_KEY, JSON.stringify({
    installed: Object.keys(OfflinePacks.installed),
    active: OfflinePacks.activePack
  }));
}

function loadPacks() {
  const raw = localStorage.getItem(PACK_KEY);
  if (!raw) return;

  const data = JSON.parse(raw);
  data.installed?.forEach(id => {
    const pack = BuiltInPacks.find(p => p.id === id);
    if (pack) OfflinePacks.installed[id] = pack;
  });

  if (data.active) activatePack(data.active);
}

/* -------------------------------
   UI ‚Äî OFFLINE PACK SELECTOR
-------------------------------- */
(function injectPackUI() {
  const harbor = document.getElementById("parent-harbor");
  if (!harbor) return;

  const box = document.createElement("div");
  box.style.marginTop = "16px";

  BuiltInPacks.forEach(pack => {
    const btn = document.createElement("button");
    btn.textContent = pack.name;
    btn.onclick = () => {
      installPack(pack);
      activatePack(pack.id);
      Mascot.react("packLoaded");
    };
    box.appendChild(btn);
  });

  harbor.appendChild(box);
})();

/* -------------------------------
   LOAD ON START
-------------------------------- */
BuiltInPacks.forEach(installPack);
loadPacks();

/* -------------------------------
   PEAK MODE SAFETY
-------------------------------- */
document.addEventListener("visibilitychange", () => {
  if (document.hidden && OfflinePacks.activePack) {
    saveCurriculumState();
  }
});

/* -------------------------------
   DEBUG
-------------------------------- */
window.__offlinePackDebug = () => ({
  active: OfflinePacks.activePack,
  installed: Object.keys(OfflinePacks.installed)
});